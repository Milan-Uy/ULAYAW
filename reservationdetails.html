<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/utilities.css" />
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />

    <title>Reservation Details</title>
  </head>
  <body>
    <!--Navbar-->
    <section class="display-navbar">
      <div id="nav-placeholder"></div>
    </section>
    <h1 class="headtextrd">Reservation Details</h1>
    <!-- <div class="check-availability-index">
      <form action="javascript:getDate()" class="checkavail-form-index">
        <div class="form-item check-flex-item">
          <i class="icon material-symbols-outlined">event_upcoming</i>
          <label>Check in</label>
          <input class="select-date" id="checkin-date" placeholder="select a date" />
        </div>
        <div class="form-item check-flex-item">
          <i class="icon material-symbols-outlined">event_busy</i>
          <label>Check out</label>
          <input id="checkout-date" class="select-date" placeholder="select a date" />
        </div>
        <div class="form-item check-flex-item-m">
          <i class="icon material-symbols-outlined">groups</i>
          <label>Guests</label>
          <input
            class="guest"
            type="number"
            placeholder="1"
            pattern="[0-9]*"
            id="spinner"
            name="value"
            value="1"
            min="1"
            max="100"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="2"
            required
          />
        </div>
        <div class="form-item check-flex-item-sm">
          <div class="search-icon">
            <button type="submit">
              <span class="icon"><i class="material-symbols-rounded"> search </i></span>
              <span class="text">CHECK AVAILABILITY</span>
            </button>
          </div>
        </div>
      </form>
    </div> -->

    <div class="columnsContainer">
      <div class="leftColumn">
        <div class="card1">
          <div class="rdimg-cont">
            <img class="rdimg" src="images/AUR2.png" />
          </div>
          <div class="rddesc-cont">
            <h6 class="villatxt">Villa Name</h6>
            <p class="rdcontent">
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
              minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
            </p>
            <p class="rd-note"><strong>Note:</strong></p>
            <!-- <p>Min. Guests: <span id="minGuest"></span></p> -->
            <p class="rd-note">Max. Guests: <span id="maxGuest"></span></p>
            <p class="pricetxt">Price</p>
          </div>
        </div>
      </div>

      <div class="rightColumn">
        <!-- <form action="javascript:getVillaId()"> -->
        <div class="card2">
          <label>Guests</label>
          <input
            class="adults"
            type="number"
            placeholder="1"
            pattern="[0-9]*"
            id="guestNo"
            name="value"
            value="1"
            min="1"
            max="30"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="3"
            required
          />
          <!-- 
          <label>Children</label>
          <input
            class="children"
            type="number"
            placeholder="0"
            pattern="[0-9]*"
            id="spinner"
            name="value"
            value="0"
            min="0"
            max="30"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="2"
            required
          /> -->
          <hr id="hrline" />
          <p id="addonstxt">Add ons:</p>
          <label id="bfasttxt">Breakfast</label>
          <input
            class="bfast"
            type="number"
            placeholder="0"
            pattern="[0-9]*"
            id="breakfast"
            name="value"
            value="0"
            min="0"
            max="30"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="2"
            required
          />
          <label id="bedtxt">Bed</label>
          <input
            class="bed"
            type="number"
            placeholder="0"
            pattern="[0-9]*"
            id="bed"
            name="value"
            value="0"
            min="0"
            max="30"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="2"
            required
          />
          <label id="bedroomtxt" class="bedroom">Extra Bedroom</label>
          <input
            class="bedroom"
            type="number"
            placeholder="0"
            pattern="[0-9]*"
            id="bedroom"
            name="value"
            value="0"
            min="0"
            max="1"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="1"
            required
          />
          <label id="tabletxt" class="table">Table Set Up</label>
          <input
            class="table"
            type="number"
            placeholder="0"
            pattern="[0-9]*"
            id="table"
            name="value"
            value="0"
            min="0"
            max="1"
            step="1"
            oninput="maxLengthCheck(this)"
            maxlength="1"
            required
          />
          <input class="confirm-btn" type="button" onclick="getVillaId()" value="Confirm" />
        </div>
        <!-- </form> -->
      </div>
    </div>
    <div class="reserve-cont">
      <div class="res-container">
        <p>Your Reservation:</p>
        <h3 style="padding-bottom: 10px">
          <span id="villatxt2">Villa Name</span><span id="price2" class="price" style="color: black"><b>Villa Price</b></span>
        </h3>
        <p>Check In: <span id="checkin"></span>, <span id="timein"> </span></p>
        <p>Check Out: <span id="checkout"></span>, <span id="timeout"> </span></p>
        <p><span id="guestDisplay"></span> Guest/s</p>
        <p id="hideday"><span id="duration"></span> Night/s</p>

        <hr />
        <p>Add-Ons Costs</p>
        <p id="hidebfast">Breakfast x <span id="bfastPrice" class="price">Breakfast Price</span><span id="bfastNo"></span></p>
        <p id="hidebed">Bed x <span id="bedPrice" class="price">Bed Price</span><span id="bedNo"></span></p>
        <p id="hidebedroom">Bedroom x <span id="bedroomPrice" class="price">Bedroom Price</span><span id="bedroomNo"></span></p>
        <p id="hidetable">Table Set Up x <span id="tablePrice" class="price">Table Set Up Price</span><span id="tableNo"></span></p>
        <hr />
        <h3>
          Total <span id="total" class="price" style="color: red"><b>P25,350.00</b></span>
        </h3>
        <p class="policyrd">
          By clicking the confirm reservation, you are agreeing to the
          <a href="#" id="open-popup-btn-1"
            ><strong><u>Booking Policy</u></strong></a
          >
          of the Hulo Leisure Farm.
        </p>
        <input class="cr-btn" id="confirmReservation" type="button" onclick="addBooking()" value="Confirm Reservation" />
      </div>
    </div>

    <!-- START OF POPUP -->
    <div class="popup popup1 center popup-long">
      <div class="description popup-content-left">
        <h2 style="text-align: center"><b>Booking Policy</b></h2>
        <br />
        1. Reservation
        <br />
        * A deposit of 20% to reserve the date.
        <br />
        * Another 30% deposit must be made 5 days before the booked date
        <br />
        * The remaining 50% can be paid upon check-in.
        <br />
        2. Early Check-in / Late Check-out
        <br />
        * It is subject to the house/room availability of that significant day. The request needs to be reconfirmed with the booking officer or Bed
        and Breakfast staff.
        <br />
        3. Booking Confirmation
        <br />
        * Upon deposit of payment, a booking confirmation must be received as this will be served as proof of your reservation.
        <br />
        4. Incidental Fee
        <br />
        * Upon check-in, we will request for a security deposit/incidental deposit of â‚±2,000. It will be returned if no damage or loss has emerged on
        our property.
      </div>
      <div class="dismiss-btn">
        <button id="dismiss-popup-btn-1">Close</button>
      </div>
    </div>

    <div class="popup popup2 popup-short center">
      <div class="popup-title">Booking</div>
      <div class="description" id="popupdesc">Message</div>
      <div class="dismiss-btn">
        <button id="confirm-popup2-btn">Close</button>
      </div>
    </div>

    <div class="popup popup3 popup-short center">
      <div class="popup-title">Booking</div>
      <div class="description">Please login to continue booking.</div>
      <div class="dismiss-btn">
        <button id="confirm-popup3-btn">Close</button>
      </div>
    </div>

    <div class="popup popup4 popup-short center">
      <div class="popup-title">Booking</div>
      <div class="description">You have already booked this villa.</div>
      <div class="dismiss-btn">
        <button id="confirm-popup4-btn">Close</button>
      </div>
    </div>
    <!-- END OF POPUP -->
    <!--Footer-->
    <section class="display-footer">
      <div id="footer-placeholder"></div>
    </section>
  </body>

  <script>
    //Import Navbar
    $(function () {
      $("#nav-placeholder").load("navbar.html");
    });
    //Import Footer
    $(function () {
      $("#footer-placeholder").load("footer.html");
    });

    // Popup Button
    document.getElementById("open-popup-btn-1").addEventListener("click", function () {
      document.getElementsByClassName("popup1")[0].classList.add("active");
    });

    document.getElementById("dismiss-popup-btn-1").addEventListener("click", function () {
      document.getElementsByClassName("popup1")[0].classList.remove("active");
    });

    const checkin = new Date(sessionStorage.getItem("checkinDate1")).toISOString();
    const checkout = new Date(sessionStorage.getItem("checkoutDate1")).toISOString();

    var checkin1 = new Date(sessionStorage.getItem("checkinDate1"));
    var checkout1 = new Date(sessionStorage.getItem("checkoutDate1"));
    var timediff = checkout1.getTime() - checkin1.getTime();
    var duration = Math.round(timediff / (1000 * 3600 * 24));
    console.log(duration);

    const getDetails = () => {
      const guest = sessionStorage.getItem("guestAmt");
      console.log(checkin);
      console.log(checkout);
      console.log(guest);
      document.getElementById("checkin").innerHTML = sessionStorage.getItem("checkinDate1");
      document.getElementById("checkout").innerHTML = sessionStorage.getItem("checkoutDate1");

      document.getElementById("guestNo").value = sessionStorage.getItem("guestAmt");
      document.getElementById("guestDisplay").innerText = sessionStorage.getItem("guestAmt");

      let options = {
        method: "GET",
        headers: {
          "Content-Type": "application/json;charset=utf-8",
          Authorization: "Bearer " + localStorage.getItem("access_token"),
        },
      };
      // console.log(`https://ulayaw-backend.herokuapp.com/villa/getAvailable?startDate=${checkin}&endDate=${checkout}&guests=${guest}`);
      fetch(`https://ulayaw-backend.herokuapp.com/villa/getAvailable?startDate=${checkin}&endDate=${checkout}&guests=${guest}`)
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
        });
    };
    getDetails();

    // get villaId
    const id = sessionStorage.getItem("villa_id");

    const getVillaId = () => {
      const guestNo = document.getElementById("guestNo").value;
      const breakfast = document.getElementById("breakfast").value;
      const bed = document.getElementById("bed").value;
      const bedroom = document.getElementById("bedroom").value;
      const table = document.getElementById("table").value;

      var breakfastval = 200 * breakfast;
      var bedval = 300 * bed;
      var bedroomval;
      var tableval = 500 * table;
      document.getElementById("bfastPrice").innerText = breakfastval;
      document.getElementById("bedPrice").innerText = bedval;

      document.getElementById("bfastNo").innerText = breakfast;
      document.getElementById("bedNo").innerText = bed;
      document.getElementById("bedroomNo").innerText = bedroom;
      document.getElementById("tableNo").innerText = table;

      let options = {
        method: "GET",
        headers: {
          "Content-Type": "application/json;charset=utf-8",
          Authorization: "Bearer " + localStorage.getItem("access_token"),
        },
      };

      fetch(`https://ulayaw-backend.herokuapp.com/villa/getOne/${id}`, options)
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
          // console.log(data.payload.name);
          document.getElementsByClassName("villatxt")[0].innerText = data.payload.name;
          document.getElementById("villatxt2").innerText = data.payload.name;
          document.getElementsByClassName("rdcontent")[0].innerText = data.payload.description;
          document.getElementById("guestDisplay").innerText = guestNo;

          if (checkin === checkout) {
            switch (data.payload.name) {
              case "Casa Aurelia":
                document.getElementById("guestNo").setAttribute("max", 30);
                document.getElementById("bed").setAttribute("max", 10);
                document.getElementsByClassName("bedroom")[0].style.display = "block";
                document.getElementById("bedroom").style.display = "block";
                document.getElementById("hidebedroom").style.display = "block";
                bedroomval = 2000 * bedroom;
                sessionStorage.setItem("bedroomvalue", bedroomval);
                document.getElementById("bedroomPrice").innerText = bedroomval;
                break;
              case "Caminos De Primavera":
                document.getElementById("guestNo").setAttribute("max", 15);
                document.getElementById("bed").setAttribute("disabled", "");
                document.getElementsByClassName("bedroom")[0].style.display = "block";
                document.getElementById("bedroom").style.display = "block";
                document.getElementById("hidebedroom").style.display = "block";
                bedroomval = 2000 * bedroom;
                sessionStorage.setItem("bedroomvalue", bedroomval);
                document.getElementById("bedroomPrice").innerText = bedroomval;
                break;
              case "Casa Salud":
                document.getElementById("guestNo").setAttribute("max", 30);
                document.getElementById("bed").setAttribute("max", 2);
                document.getElementsByClassName("bedroom")[0].style.display = "block";
                document.getElementById("bedroom").style.display = "block";
                document.getElementById("hidebedroom").style.display = "block";
                bedroomval = 1500 * bedroom;
                sessionStorage.setItem("bedroomvalue", bedroomval);
                document.getElementById("bedroomPrice").innerText = bedroomval;
                break;
              case "Kubo ni Basyong":
                document.getElementById("guestNo").setAttribute("max", 4);
                document.getElementById("bed").setAttribute("disabled", "");
                document.getElementById("breakfast").setAttribute("disabled", "");
                document.getElementsByClassName("table")[0].style.display = "block";
                document.getElementById("table").style.display = "block";
                document.getElementById("hidetable").style.display = "block";
                document.getElementById("tablePrice").innerText = tableval;
                breakfastval = 0;
                bedval = 0;
                bedroomval = 0;
                break;
              case "Celso Tagle Hall":
                document.getElementById("guestNo").setAttribute("max", 100);
                document.getElementById("bed").setAttribute("disabled", "");
                document.getElementById("breakfast").setAttribute("disabled", "");
                breakfastval = 0;
                bedval = 0;
                bedroomval = 0;
                break;
            }
            document.getElementById("addonstxt").style.display = "none";
            document.getElementById("bed").style.display = "none";
            document.getElementById("hidebfast").style.display = "none";
            document.getElementById("hidebed").style.display = "none";
            document.getElementById("breakfast").style.display = "none";
            document.getElementById("bfasttxt").style.display = "none";
            document.getElementById("bedtxt").style.display = "none";
            document.getElementById("hrline").style.display = "none";
            document.getElementById("hideday").style.display = "none";
            document.getElementsByClassName("pricetxt")[0].innerText = data.payload.dayTour.price;
            document.getElementById("price2").innerText = data.payload.dayTour.price;
            document.getElementById("timein").innerText = data.payload.dayTour.checkInTime;
            document.getElementById("timeout").innerText = data.payload.dayTour.checkOutTime;
            // document.getElementById("minGuest").innerText = data.payload.dayTour.minPerson;
            document.getElementById("maxGuest").innerText = data.payload.dayTour.maxPerson;
            var villaPrice = data.payload.dayTour.price;
            var total = villaPrice + breakfastval + bedval + bedroomval + tableval;
            sessionStorage.setItem("totalPrice", total);
            document.getElementById("total").innerText = total;
          } else {
            switch (data.payload.name) {
              case "Casa Aurelia":
                document.getElementById("guestNo").setAttribute("max", 20);
                document.getElementById("bed").setAttribute("max", 10);
                break;
              case "Caminos De Primavera":
                document.getElementById("guestNo").setAttribute("max", 6);
                document.getElementById("bed").setAttribute("disabled", "");
                break;
              case "Casa Salud":
                document.getElementById("guestNo").setAttribute("max", 7);
                document.getElementById("bed").setAttribute("max", 2);
                break;
              case "Kubo ni Basyong":
                document.getElementById("bed").setAttribute("disabled", "");
                document.getElementById("breakfast").setAttribute("disabled", "");
                break;
              case "Celso Tagle Hall":
                document.getElementById("bed").setAttribute("disabled", "");
                document.getElementById("breakfast").setAttribute("disabled", "");
                break;
            }
            document.getElementsByClassName("pricetxt")[0].innerText = data.payload.overnight.price;
            document.getElementById("price2").innerText = data.payload.overnight.price;
            document.getElementById("timein").innerText = data.payload.overnight.checkInTime;
            document.getElementById("timeout").innerText = data.payload.overnight.checkOutTime;
            document.getElementById("duration").innerText = duration;
            // document.getElementById("minGuest").innerText = data.payload.overnight.minPerson;
            document.getElementById("maxGuest").innerText = data.payload.overnight.maxPerson;
            var villaPrice = data.payload.overnight.price;
            var total = villaPrice + breakfastval + bedval;
            sessionStorage.setItem("totalPrice", total);
            document.getElementById("total").innerText = total;
          }
        });
    };
    getVillaId();

    const addBooking = () => {
      const guestNumber = document.getElementById("guestDisplay").innerHTML;

      if (localStorage.getItem("access_token")) {
        const breakfast = document.getElementById("breakfast").value;
        const bed = document.getElementById("bed").value;
        const bedroom = document.getElementById("bedroom").value;
        const table = document.getElementById("table").value;

        var breakfastval = 200 * breakfast;
        var bedval = 300 * bed;
        var bedroomval;
        var tableval = 500 * table;

        var bedroomvalue = sessionStorage.getItem("bedroomvalue");

        let bookingType;
        let totalPrice = sessionStorage.getItem("totalPrice", total);
        console.log(totalPrice);
        if (checkin === checkout) {
          bookingType = "dayTour";
        } else {
          bookingType = "overnight";
        }

        let bookingData = {
          villaId: id,
          startDate: checkin,
          endDate: checkout,
          bookingType: bookingType,
          price: totalPrice,
          noOfGuests: guestNumber,
          totalAmount: totalPrice,
          isPaid: false,
          addOns: [
            { addOnName: "Extra Bed", qty: bed, price: bedval },
            { addOnName: "Extra Breakfast", qty: breakfast, price: breakfastval },
            { addOnName: "Extra Bedroom", qty: bedroom, price: bedroomvalue },
            { addOnName: "Table Set Up", qty: table, price: tableval },
          ],
        };

        let options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          body: JSON.stringify(bookingData),
        };

        fetch("https://ulayaw-backend.herokuapp.com/booking/add", options)
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            if (data.message == "Booking created!") {
              document.getElementById("popupdesc").innerHTML = data.message;

              document.getElementsByClassName("popup2")[0].classList.add("active");

              document.getElementById("confirm-popup2-btn").addEventListener("click", function () {
                document.getElementsByClassName("popup2")[0].classList.remove("active");
              });
              //disable button when booking is created to prevent duplicate
              document.getElementById("confirmReservation").disabled = true;
            } else {
              document.getElementById("popupdesc").innerHTML = data.message;

              document.getElementsByClassName("popup2")[0].classList.add("active");

              document.getElementById("confirm-popup2-btn").addEventListener("click", function () {
                document.getElementsByClassName("popup2")[0].classList.remove("active");
              });
            }
          });
        // popup when trying to book while not logged in
      } else {
        document.getElementsByClassName("popup3")[0].classList.add("active");

        document.getElementById("confirm-popup3-btn").addEventListener("click", function () {
          document.getElementsByClassName("popup3")[0].classList.remove("active");
        });
      }
    };

    // disable typing in number input
    $("[type='number']").keypress(function (evt) {
      evt.preventDefault();
    });

    //Date Picker

    // endDate.setDate(endDate.getDate() + 1);

    // const picker = new Litepicker({
    //   element: document.getElementById("checkin-date"),
    //   elementEnd: document.getElementById("checkout-date"),
    //   numberOfMonths: 2,
    //   numberOfColumns: 2,
    //   singleMode: false,
    //   numberOfMonths: 2,
    //   allowRepick: true,
    //   minDays: 1, // Sets the min amount of days to 1
    //   maxDays: 730, // Sets the min amount of days to 1
    //   format: "D MMM, YYYY", // Format date
    //   minDate: startDate, //It will not allow to select past days
    // });
    // //Input Number
    // function spinner() {
    //   // Spinner
    //   $("#spinner").spinner();

    //   //Input only numbers
    //   $("#spinner").keyup(function () {
    //     this.value = this.value.replace(/[^0-9]/g, "");
    //   });
    // }
    //Input max number
    function maxLengthCheck(object) {
      if (object.value.length > object.maxLength) object.value = object.value.slice(0, object.maxLength);
    }

    // window.onload = spinner;
  </script>
</html>
